# farmasiKu 完整功能说明

## 📋 项目概述

farmasiKu 是一个基于症状的在线药房咨询和购药系统，支持实时咨询、药物推荐、在线下单等功能。

---

## 🎯 核心功能模块

### 1. 用户认证系统 (Authentication)

#### 功能列表：
- ✅ **用户登录** (`Login.jsx`)
  - 邮箱/密码登录
  - 支持 Supabase Auth
  - 错误处理和提示
  
- ✅ **用户注册** (`Register.jsx`)
  - 新用户注册
  - 自动创建用户档案
  
- ✅ **忘记密码** (`ForgotPassword.jsx`)
  - 发送密码重置邮件
  
- ✅ **重置密码** (`ResetPassword.jsx`)
  - 通过邮件链接重置密码
  
- ✅ **用户角色管理**
  - 支持 `user` 和 `admin` 两种角色
  - Admin 自动跳转到管理面板
  - 普通用户进入主应用流程

---

### 2. 症状评估流程 (Symptom Assessment Flow)

#### 流程步骤：

1. **欢迎页面** (`Welcome.jsx`)
   - 应用入口
   - 开始症状评估

2. **年龄输入** (`AgeInput.jsx`)
   - 输入用户年龄
   - 用于后续药物推荐和年龄限制检查

3. **身体部位选择** (`BodyPartSelection.jsx`)
   - 选择症状所在的身体部位
   - 支持：皮肤、脚部、头部、胸部、腹部、其他

4. **症状选择** (`SymptomSelection.jsx`)
   - 根据身体部位显示相关症状
   - 支持多选
   - 内联症状评估（无需跳转页面）
   - 支持"选择更多症状"

5. **症状评估** (`SymptomAssessment.jsx`)
   - 详细评估每个症状
   - 严重程度、持续时间等

6. **症状确认** (`SymptomConfirmation.jsx`)
   - 确认所有选择的症状
   - 选择严重程度：
     - **More severe** → 进入实时咨询流程
     - **Current** → 进入药物推荐流程

7. **危险症状警告** (`DangerWarning.jsx`)
   - 检测危险症状（如呼吸困难、胸痛等）
   - 建议立即咨询药剂师
   - 或继续普通流程

---

### 3. 实时咨询系统 (Realtime Consultation System)

#### 3.1 用户端咨询流程

**组件：`ConsultationWaiting.jsx` 和 `ConsultationQueue.jsx`**

- ✅ **创建咨询队列**
  - 用户选择"More severe"后自动创建队列
  - 状态：`waiting`
  - 包含症状信息、年龄、身体部位等

- ✅ **自动匹配药剂师**
  - 创建队列后立即尝试匹配可用药剂师
  - 查找条件：
    - `is_online = true`
    - `is_busy = false`
    - 选择当前会话数最少的药剂师
  - 匹配成功后：
    - 更新队列状态为 `matched`
    - 创建咨询会话 (`consultation_sessions`)
    - 更新药剂师状态为忙碌
    - 自动进入聊天界面

- ✅ **等待界面显示**
  - 队列位置 (#1, #2, ...)
  - 预计等待时间（分钟）
  - 在线药剂师数量
  - 实时更新（每5秒）

- ✅ **实时状态订阅**
  - 订阅队列状态变化（Realtime）
  - 当状态变为 `matched` 时自动进入聊天

- ✅ **取消队列**
  - 用户可以取消等待中的队列

#### 3.2 聊天系统 (`SimpleChat.jsx`)

**功能：**
- ✅ **实时消息**
  - 支持文本消息
  - Realtime 订阅（Supabase Realtime）
  - 轮询后备机制（每2秒）
  - 自动滚动到底部

- ✅ **药物推荐**
  - 药剂师可以推荐药物
  - 填写药物信息：
    - 药物名称
    - 剂量 (Dosage)
    - 频率 (Frequency)
    - 持续时间 (Duration)
    - 使用说明 (Instructions)
  - 推荐后发送系统消息

- ✅ **药物接受/拒绝**
  - 用户可以看到推荐药物卡片
  - 可以接受或拒绝推荐
  - 接受的药物会保存到数据库

- ✅ **结束咨询**
  - 用户点击"完成咨询"
  - 如果有接受的药物，进入药物确认页面
  - 如果没有，显示确认对话框

#### 3.3 药物确认页面 (`ConsultationMedicationReview.jsx`)

**功能：**
- ✅ 显示所有接受的药物
- ✅ 显示每个药物的详细信息：
  - 名称、价格
  - 剂量、频率、持续时间
  - 使用说明
- ✅ 显示总价和总数量
- ✅ 继续到配送和支付页面

---

### 4. 药物推荐系统 (Medication Recommendation)

#### 4.1 自动推荐 (`MedicationRecommendation.jsx`)

**功能：**
- ✅ 根据症状自动推荐药物
- ✅ 从数据库获取药物（优先）
- ✅ 静态数据后备（如果数据库不可用）
- ✅ 年龄限制检查：
  - 儿童：某些药物不适用，提供替代品
  - 老年人：建议咨询医生调整剂量
- ✅ 显示药物详细信息：
  - 价格
  - 使用方法
  - 剂量说明
  - 使用频率

#### 4.2 药剂师推荐 (`MedicationRecommendationForm.jsx`)

**功能：**
- ✅ 药剂师在聊天中推荐药物
- ✅ 搜索药物数据库
- ✅ 填写推荐信息
- ✅ 发送推荐消息

---

### 5. 订单系统 (Order System)

#### 5.1 配送信息 (`DeliveryInfo.jsx`)

**功能：**
- ✅ 输入配送地址
  - 地址行1、地址行2
  - 邮政编码
  - 城市、州
- ✅ 输入电话号码
- ✅ 地址管理（保存常用地址）

#### 5.2 支付 (`Payment.jsx`)

**功能：**
- ✅ 选择支付方式
- ✅ 显示订单总价
- ✅ 处理支付（模拟）
- ✅ 保存订单到数据库

#### 5.3 订单成功 (`OrderSuccess.jsx`)

**功能：**
- ✅ 显示订单确认
- ✅ 显示订单详情
- ✅ 返回首页

#### 5.4 订单跟踪 (`OrderTracking.jsx`)

**功能：**
- ✅ 查看订单状态
- ✅ 跟踪配送进度
- ✅ 显示订单历史

---

### 6. 管理员系统 (Admin System)

#### 6.1 管理面板 (`FarmasiAdmin.jsx`)

**标签页：**

1. **📊 Dashboard（仪表板）**
   - 总营收
   - 总订单数
   - 总用户数
   - 总咨询数
   - 今日订单和营收
   - 最近订单列表

2. **📦 Orders（订单管理）**
   - 查看所有订单
   - 筛选：全部/今日/本周/本月
   - 搜索订单
   - 订单操作：
     - ✅ 接受订单（设置预计配送时间）
     - 📦 标记为准备中
     - 🚚 标记为配送中
     - ✅ 标记为已送达
   - 显示配送地址和电话

3. **👥 Users（用户管理）**
   - 查看所有用户
   - 显示用户角色（user/admin）
   - 切换用户角色（设为管理员/移除管理员）

4. **💬 Consultations（咨询管理）**
   - 查看所有咨询记录
   - 显示症状和身体部位

5. **💊 Medications（药物管理）**
   - 查看所有药物
   - 编辑药物价格
   - 编辑库存数量
   - 添加库存
   - 搜索药物
   - 显示库存状态（有货/缺货/低库存）

6. **👨‍⚕️ Pharmacists（药剂师管理）**
   - 查看所有药剂师
   - 添加新药剂师
   - 编辑药剂师信息（姓名、专业、简介）
   - 设置可用性（可用/不可用）
   - **链接药剂师账号**：
     - Admin 可以将药剂师账号链接到自己的用户账号
     - 链接后可以以该药剂师身份回复咨询
   - 取消链接
   - 删除药剂师

7. **💬 Pharmacist Dashboard（药剂师工作台）**
   - 查看等待中的咨询队列
   - 查看活跃的咨询会话
   - 接受咨询并开始聊天
   - 设置在线/离线状态

#### 6.2 药剂师工作台 (`PharmacistDashboard.jsx`)

**功能：**
- ✅ **查看等待队列**
  - 显示所有 `status = 'waiting'` 的队列
  - 显示患者信息、症状、年龄
  - 显示加入时间
  - Admin 可以看到所有等待队列
  - 链接了药剂师账号的用户也可以看到

- ✅ **接受咨询**
  - 点击"Accept & Start Chat"
  - 更新队列状态：`waiting` → `accepted` → `in_chat`
  - 创建咨询会话
  - 更新药剂师状态为忙碌
  - 进入聊天界面

- ✅ **活跃会话管理**
  - 显示当前活跃的咨询会话
  - 点击"Open Chat"继续聊天

- ✅ **在线状态管理**
  - 设置在线/离线
  - 更新 `pharmacist_availability` 表

- ✅ **实时更新**
  - 订阅队列和会话变化
  - 自动刷新数据

---

### 7. 用户个人中心 (`Profile.jsx`)

**功能：**
- ✅ 查看用户信息
- ✅ 查看订单历史
- ✅ 订单跟踪
- ✅ 退出登录
- ✅ 重新开始流程

---

### 8. 通知中心 (`NotificationCenter.jsx`)

**功能：**
- ✅ 显示用户通知
- ✅ 订单状态更新通知
- ✅ 咨询消息通知

---

## 🔄 完整用户流程

### 流程 A: 普通症状 → 药物推荐 → 下单

```
欢迎页 → 年龄输入 → 身体部位选择 → 症状选择 → 症状评估 → 
症状确认（选择 Current）→ 药物推荐 → 选择药物 → 
配送信息 → 支付 → 订单成功
```

### 流程 B: 严重症状 → 实时咨询 → 药物推荐 → 下单

```
欢迎页 → 年龄输入 → 身体部位选择 → 症状选择 → 症状评估 → 
症状确认（选择 More severe）→ 创建队列 → 自动匹配药剂师 → 
实时聊天 → 药剂师推荐药物 → 用户接受药物 → 
完成咨询 → 药物确认 → 配送信息 → 支付 → 订单成功
```

### 流程 C: 危险症状 → 强制咨询

```
症状选择 → 检测到危险症状 → 危险警告 → 
选择咨询 → 创建队列 → 自动匹配 → 实时聊天 → ...
```

---

## 🗄️ 数据库结构

### 主要数据表：

1. **`user_profiles`** - 用户档案
   - id, age, role (user/admin), created_at

2. **`doctors`** - 药剂师信息
   - id, user_id, name, specialization, bio, is_available

3. **`pharmacist_availability`** - 药剂师在线状态
   - pharmacist_id, is_online, is_busy, current_sessions_count

4. **`consultation_queue`** - 咨询队列
   - id, patient_id, status (waiting/matched/in_chat/completed/cancelled)
   - symptoms, notes, pharmacist_id, matched_at, created_at

5. **`consultation_sessions`** - 咨询会话
   - id, patient_id, doctor_id, queue_id, status, started_at, ended_at

6. **`consultation_messages`** - 咨询消息
   - id, session_id, sender_id, sender_type, content, message_type, created_at

7. **`consultation_medications`** - 咨询推荐药物
   - id, session_id, medication_id, medication_name, dosage, frequency
   - status (pending/accepted/rejected), recommended_by

8. **`medications`** - 药物库存
   - id, name, price, stock, age_restrictions, is_active

9. **`orders`** - 订单
   - id, user_id, total_amount, payment_method, delivery_status
   - delivery_address, phone_number, created_at

10. **`order_items`** - 订单项
    - id, order_id, medication_name, medication_price, quantity

---

## 🔐 权限系统 (RLS - Row Level Security)

### 用户角色：
- **user**: 普通用户
- **admin**: 管理员

### RLS 策略：

1. **consultation_queue**
   - 用户：可以创建自己的队列，查看自己的队列
   - Admin：可以查看所有等待队列
   - 链接了药剂师账号的用户：可以查看等待队列

2. **consultation_sessions**
   - 用户：可以查看自己的会话
   - 药剂师：可以查看分配给自己的会话

3. **consultation_messages**
   - 用户：可以查看自己参与的会话消息
   - 药剂师：可以查看分配给自己的会话消息

4. **orders**
   - 用户：可以查看自己的订单
   - Admin：可以查看所有订单

5. **medications**
   - 所有用户：可以查看
   - Admin：可以编辑价格和库存

6. **doctors**
   - 所有用户：可以查看可用药剂师
   - Admin：可以管理所有药剂师

---

## 🎨 UI/UX 特性

- ✅ 响应式设计
- ✅ 进度指示器
- ✅ 加载状态
- ✅ 错误处理
- ✅ 实时更新动画
- ✅ 等待动画（脉冲圆圈）
- ✅ 消息气泡样式
- ✅ 药物卡片设计

---

## 🔧 技术栈

- **前端框架**: React 18.2
- **构建工具**: Vite 5.0
- **数据库**: Supabase (PostgreSQL)
- **认证**: Supabase Auth
- **实时通信**: Supabase Realtime
- **部署**: Vercel

---

## 📦 服务层 (Services)

### `consultationService.js`
- `createQueue()` - 创建队列
- `matchPharmacist()` - 匹配药剂师
- `getQueuePosition()` - 获取队列位置
- `cancelQueue()` - 取消队列
- `getOnlinePharmacistsCount()` - 获取在线药剂师数量
- `recommendMedication()` - 推荐药物
- `acceptMedication()` - 接受药物推荐
- `rejectMedication()` - 拒绝药物推荐
- `endConsultation()` - 结束咨询

### `databaseService.js`
- `saveConsultationSession()` - 保存咨询会话
- `saveOrder()` - 保存订单
- `getOrderHistory()` - 获取订单历史
- `getMedicationsBySymptoms()` - 根据症状获取药物

---

## 🚀 当前状态

### ✅ 已实现功能
1. 完整的用户认证系统
2. 症状评估流程
3. 实时咨询系统（自动匹配）
4. 实时聊天功能
5. 药物推荐系统
6. 订单管理系统
7. 管理员面板
8. 药剂师工作台
9. 用户个人中心
10. 订单跟踪

### ⚠️ 当前问题
1. **自动匹配可能失败**
   - 显示有2个在线药剂师，但匹配不成功
   - 可能原因：RLS 策略、数据库字段不匹配、匹配逻辑错误

### 🔄 代码状态
- ✅ 统一使用 `ConsultationQueue` 组件（main 分支版本）
- ✅ 已移除未使用的 `ConsultationWaiting` 导入
- `ConsultationQueue` 功能：
  - 创建队列后立即尝试自动匹配
  - 如果匹配成功，直接进入聊天
  - 如果匹配失败，显示等待界面
  - 支持实时订阅队列状态变化

---

## 📝 建议

1. **统一队列组件**
   - 决定使用 `ConsultationWaiting` 还是 `ConsultationQueue`
   - 更新 `App.jsx` 使用正确的组件

2. **修复自动匹配**
   - 检查 RLS 策略
   - 检查数据库字段（`matched_pharmacist_id` vs `pharmacist_id`）
   - 添加更详细的错误日志

3. **数据库一致性**
   - 确保数据库结构与代码一致
   - 检查状态值（`waiting`/`matched`/`in_chat` vs `accepted`/`in_chat`）

---

## 🎯 总结

这是一个功能完整的在线药房系统，包含：
- ✅ 用户认证和角色管理
- ✅ 症状评估和药物推荐
- ✅ 实时咨询和聊天
- ✅ 订单管理和配送跟踪
- ✅ 管理员面板和药剂师工作台

主要问题集中在咨询队列的自动匹配功能，需要进一步调试和修复。

