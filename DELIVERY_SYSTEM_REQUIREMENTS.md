# 配送系统功能需求文档

## 📋 功能概述

实现类似 Foodpanda 的配送管理系统，包括地址管理、订单接单、配送跟踪和状态更新。

---

## 🔄 完整流程

### 阶段 1: 用户下单前（地址和电话）

#### 1.1 地址管理
- **新增地址表单**：
  - 地址标签（如：家、公司、其他）
  - 详细地址（必填）
  - 邮政编码（可选）
  - 城市/地区（可选）
  - 设为默认地址（复选框）

- **地址选择**：
  - 显示已保存的地址列表
  - 可以选择之前保存的地址
  - 可以编辑或删除已有地址
  - 可以添加新地址

#### 1.2 电话号码
- 电话号码输入（必填）
- 验证格式
- 可以保存多个电话号码
- 选择使用哪个电话号码

#### 1.3 在支付流程中的位置
- 在 "Payment" 页面之前添加 "Delivery Info" 页面
- 或者在 Payment 页面中包含地址和电话选择

---

### 阶段 2: 订单创建后

#### 2.1 订单状态
- `pending` - 待接单（默认）
- `accepted` - 已接单
- `preparing` - 准备中/出货中
- `out_for_delivery` - 送货中
- `delivered` - 已送达
- `cancelled` - 已取消

#### 2.2 订单信息存储
- 配送地址（完整地址信息）
- 电话号码
- 预计送达时间（由管理员设置）
- 实际送达时间（客户确认时记录）

---

### 阶段 3: 管理员接单和管理

#### 3.1 订单列表显示
- 显示所有待接单的订单（状态：pending）
- 显示订单详情：
  - 订单 ID
  - 客户信息（如果有）
  - 配送地址
  - 电话号码
  - 订单商品列表
  - 订单金额
  - 下单时间

#### 3.2 接单功能
- "接单" 按钮
- 点击后弹出对话框：
  - **预计送达时间选择**：
    - 小时选择（0-23）
    - 分钟选择（只能选择：15, 30, 45）
    - 显示预计送达时间预览
  - 确认接单按钮

#### 3.3 订单状态更新
- **准备中/出货中**：
  - 管理员点击 "出货" 按钮
  - 状态更新为 `preparing`
  
- **送货中**：
  - 管理员点击 "开始送货" 按钮
  - 状态更新为 `out_for_delivery`
  - 可以添加配送员信息（可选）

#### 3.4 订单管理界面
- 按状态筛选订单（待接单、已接单、送货中、已完成）
- 显示每个订单的当前状态
- 显示预计送达时间
- 显示订单时间线

---

### 阶段 4: 客户端通知和确认

#### 4.1 订单状态通知
- 当订单状态更新时，显示通知：
  - "订单已接单，预计 XX:XX 送达"
  - "订单已出货"
  - "订单正在配送中"
  - "订单已送达，请确认收货"

#### 4.2 订单跟踪页面
- 显示订单当前状态
- 显示预计送达时间
- 显示订单时间线（接单时间、出货时间、开始配送时间）

#### 4.3 确认收货
- 当订单状态为 `out_for_delivery` 时，显示 "确认收货" 按钮
- 客户点击后：
  - 状态更新为 `delivered`
  - 记录实际送达时间
  - 显示感谢信息

---

## 📊 数据库设计

### 新增表

#### 1. `user_addresses` 表
```sql
- id (UUID, PRIMARY KEY)
- user_id (UUID, REFERENCES auth.users)
- label (TEXT) - 地址标签（家、公司等）
- address_line1 (TEXT) - 详细地址
- address_line2 (TEXT) - 地址第二行（可选）
- postal_code (TEXT) - 邮政编码
- city (TEXT) - 城市
- state (TEXT) - 州/省
- country (TEXT) - 国家（默认：Malaysia）
- is_default (BOOLEAN) - 是否默认地址
- phone_number (TEXT) - 电话号码
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)
```

#### 2. `order_delivery` 表（或扩展 orders 表）
```sql
- order_id (UUID, REFERENCES orders, PRIMARY KEY)
- delivery_address (JSONB) - 完整地址信息
- phone_number (TEXT) - 配送电话号码
- estimated_delivery_time (TIMESTAMP) - 预计送达时间
- actual_delivery_time (TIMESTAMP) - 实际送达时间
- delivery_status (TEXT) - 配送状态
- delivery_person (TEXT) - 配送员信息（可选）
- accepted_at (TIMESTAMP) - 接单时间
- preparing_at (TIMESTAMP) - 出货时间
- out_for_delivery_at (TIMESTAMP) - 开始配送时间
- delivered_at (TIMESTAMP) - 送达时间
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)
```

#### 3. 扩展 `orders` 表
```sql
- 添加 delivery_status 字段（如果不用单独的表）
- 添加 delivery_address 字段
- 添加 phone_number 字段
- 添加 estimated_delivery_time 字段
```

---

## 🎨 用户界面设计

### 用户端

#### 1. 地址管理页面
- 地址列表（卡片式）
- 每个地址显示：标签、地址、电话、默认标记
- "添加新地址" 按钮
- 编辑/删除按钮

#### 2. 配送信息页面（下单流程中）
- 选择地址（下拉或卡片选择）
- 或添加新地址
- 选择/输入电话号码
- "继续" 按钮

#### 3. 订单跟踪页面
- 订单状态卡片
- 时间线显示
- 预计送达时间
- "确认收货" 按钮（当状态为送货中时）

### 管理员端

#### 1. 订单管理页面
- 订单列表（按状态分组）
- 每个订单显示：
  - 订单信息
  - 配送地址
  - 电话号码
  - 当前状态
  - 操作按钮（接单、出货、开始配送）

#### 2. 接单对话框
- 订单详情
- 预计送达时间选择器
- 确认按钮

---

## 🔔 通知系统

### 通知方式
1. **应用内通知**（推荐）
   - 使用 Supabase Realtime 监听订单状态变化
   - 显示通知横幅或弹窗

2. **浏览器通知**（可选）
   - 使用浏览器 Notification API
   - 需要用户授权

### 通知内容
- "您的订单已被接单，预计 XX:XX 送达"
- "您的订单已出货"
- "您的订单正在配送中"
- "您的订单已送达，请确认收货"

---

## ⏰ 时间选择规则

### 预计送达时间
- **小时**：0-23（24小时制）
- **分钟**：只能选择 15, 30, 45
- **示例**：
  - 14:15
  - 14:30
  - 14:45
  - 15:15
  - 等等

### 时间计算
- 从当前时间开始计算
- 管理员选择的时间不能早于当前时间
- 建议最短配送时间：30分钟

---

## 📱 功能优先级

### 第一阶段（核心功能）
1. ✅ 地址管理（添加、选择、编辑、删除）
2. ✅ 电话号码输入和保存
3. ✅ 订单接单功能
4. ✅ 预计送达时间选择
5. ✅ 订单状态更新（接单、出货、送货中）
6. ✅ 客户确认收货

### 第二阶段（增强功能）
1. ⏳ 实时通知
2. ⏳ 订单跟踪页面
3. ⏳ 配送员信息
4. ⏳ 订单时间线

### 第三阶段（可选功能）
1. ⏳ 地图集成
2. ⏳ GPS 跟踪
3. ⏳ 短信通知
4. ⏳ 配送历史记录

---

## ❓ 需要确认的问题

1. **地址管理**：
   - 是否需要地址验证？
   - 是否需要地图选择地址？
   - 最多保存多少个地址？

2. **电话号码**：
   - 是否需要验证（发送验证码）？
   - 是否需要国际格式？

3. **配送时间**：
   - 最短配送时间是多少？（建议30分钟）
   - 是否允许选择当天的时间？
   - 是否需要考虑营业时间？

4. **通知方式**：
   - 只需要应用内通知，还是也需要浏览器通知？
   - 是否需要短信通知？

5. **订单取消**：
   - 客户可以取消订单吗？
   - 管理员可以取消订单吗？
   - 取消规则是什么？

6. **配送费用**：
   - 是否需要计算配送费用？
   - 配送费用如何计算？

---

## 📝 下一步

请确认以上流程和要求，特别是：
- ✅ 流程是否符合你的需求
- ✅ 数据库设计是否合理
- ✅ 界面设计是否符合预期
- ✅ 回答需要确认的问题

确认后，我将开始实现功能。

