# é‡æ„å®æ–½æŒ‡å—

## ğŸ“‹ å®æ–½æ­¥éª¤

### æ­¥éª¤ 1: è¿è¡Œæ•°æ®åº“é‡å»ºè„šæœ¬

åœ¨ Supabase SQL Editor ä¸­è¿è¡Œï¼š

```sql
-- è¿è¡Œ database/rebuild_consultation_queue_rls.sql
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- âœ… åˆ é™¤æ‰€æœ‰æ—§çš„ RLS ç­–ç•¥
- âœ… åˆ›å»ºæ–°çš„ã€æ¸…æ™°çš„ RLS ç­–ç•¥
- âœ… ä½¿ç”¨ç›´æ¥è§’è‰²æ£€æŸ¥ï¼ˆä¸ä½¿ç”¨å‡½æ•°ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- åº”è¯¥çœ‹åˆ° "Verification: All Policies" æ˜¾ç¤ºè‡³å°‘ 7 ä¸ªç­–ç•¥

---

### æ­¥éª¤ 2: éªŒè¯ RLS ç­–ç•¥

åœ¨ Supabase SQL Editor ä¸­è¿è¡Œï¼š

```sql
-- è¿è¡Œ database/verify_new_rls.sql
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- âœ… æ£€æŸ¥ç­–ç•¥æ•°é‡
- âœ… åˆ—å‡ºæ‰€æœ‰ç­–ç•¥
- âœ… æµ‹è¯• Admin ç”¨æˆ·æŸ¥è¯¢
- âœ… æ˜¾ç¤ºå¯è§çš„é˜Ÿåˆ—

**æŸ¥çœ‹ç»“æœ**ï¼š
- `Step 5`: å¦‚æœä»¥ Admin ç™»å½•ï¼Œåº”è¯¥æ˜¾ç¤º `âœ… SUCCESS`
- `Step 7`: æµ‹è¯• Admin ç”¨æˆ·ï¼Œåº”è¯¥æ˜¾ç¤º `âœ… Admin user would see queues`

---

### æ­¥éª¤ 3: æ›´æ–°å‰ç«¯ä»£ç 

å‰ç«¯ä»£ç å·²ç»æ›´æ–°ï¼š
- âœ… ç®€åŒ–äº†æŸ¥è¯¢é€»è¾‘
- âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†
- âœ… æ·»åŠ äº†æ›´è¯¦ç»†çš„æ—¥å¿—

**æ— éœ€é¢å¤–æ“ä½œ**ï¼Œä»£ç å·²æ›´æ–°ã€‚

---

### æ­¥éª¤ 4: åœ¨åº”ç”¨ä¸­æµ‹è¯•

1. **ä»¥ Admin ç”¨æˆ·ç™»å½•åº”ç”¨**
   - ç”¨æˆ· ID: `56e324aa-e1dd-40a8-9e96-2473cfcba661`

2. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°**ï¼ˆF12ï¼‰

3. **è¿›å…¥ Pharmacist Dashboard**
   - åœ¨ Admin Dashboard ä¸­ç‚¹å‡» "Pharmacist" æ ‡ç­¾

4. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**ï¼š
   ```
   [PharmacistDashboard] User info: { userId: ..., role: 'admin', ... }
   [PharmacistDashboard] Loading waiting queues...
   [PharmacistDashboard] Waiting queues result: { queues: [...], queueError: null, count: X }
   ```

5. **æ£€æŸ¥ç»“æœ**ï¼š
   - `role`: åº”è¯¥æ˜¯ `'admin'`
   - `queueError`: åº”è¯¥æ˜¯ `null`
   - `count`: åº”è¯¥ > 0ï¼ˆå¦‚æœæœ‰ waiting é˜Ÿåˆ—ï¼‰

---

## âœ… éªŒè¯æ¸…å•

- [ ] è¿è¡Œ `rebuild_consultation_queue_rls.sql`
- [ ] è¿è¡Œ `verify_new_rls.sql` éªŒè¯ç­–ç•¥
- [ ] ä»¥ Admin ç”¨æˆ·ç™»å½•åº”ç”¨
- [ ] æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
- [ ] è¿›å…¥ Pharmacist Dashboard
- [ ] æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
- [ ] ç¡®è®¤èƒ½çœ‹åˆ° waiting é˜Ÿåˆ—

---

## ğŸ” å¦‚æœè¿˜æœ‰é—®é¢˜

### é—®é¢˜ 1: ä»ç„¶çœ‹ä¸åˆ°é˜Ÿåˆ—

**æ£€æŸ¥**ï¼š
1. æµè§ˆå™¨æ§åˆ¶å°çš„æ—¥å¿—
2. Network æ ‡ç­¾ä¸­çš„ API è¯·æ±‚
3. æ˜¯å¦æœ‰ waiting é˜Ÿåˆ—å­˜åœ¨

**è§£å†³**ï¼š
- è¿è¡Œ `verify_new_rls.sql` æŸ¥çœ‹è¯Šæ–­ç»“æœ
- æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦æ­£ç¡®

### é—®é¢˜ 2: çœ‹åˆ°é”™è¯¯ä¿¡æ¯

**æ£€æŸ¥**ï¼š
- é”™è¯¯ä»£ç å’Œæ¶ˆæ¯
- æ˜¯å¦æ˜¯ RLS ç­–ç•¥é”™è¯¯

**è§£å†³**ï¼š
- æ ¹æ®é”™è¯¯ä¿¡æ¯è°ƒæ•´ç­–ç•¥
- æ£€æŸ¥ç”¨æˆ·æƒé™

---

## ğŸ“ æ–°ç­–ç•¥è¯´æ˜

### SELECT ç­–ç•¥ï¼ˆæŸ¥çœ‹ï¼‰

1. **ç”¨æˆ·è‡ªå·±çš„é˜Ÿåˆ—**ï¼š`auth.uid() = patient_id`
2. **Admin æŸ¥çœ‹ waiting**ï¼š`status = 'waiting' AND role = 'admin'`
3. **Admin æŸ¥çœ‹ matched**ï¼š`status IN ('matched', 'in_consultation') AND role = 'admin'`
4. **é“¾æ¥ pharmacist æŸ¥çœ‹ waiting**ï¼š`status = 'waiting' AND EXISTS (SELECT 1 FROM doctors WHERE user_id = auth.uid())`

### INSERT ç­–ç•¥ï¼ˆåˆ›å»ºï¼‰

- ç”¨æˆ·åªèƒ½åˆ›å»ºè‡ªå·±çš„é˜Ÿåˆ—

### UPDATE ç­–ç•¥ï¼ˆæ›´æ–°ï¼‰

1. ç”¨æˆ·æ›´æ–°è‡ªå·±çš„é˜Ÿåˆ—
2. é“¾æ¥ pharmacist æ¥å—é˜Ÿåˆ—ï¼ˆwaiting â†’ matched/in_consultationï¼‰
3. é“¾æ¥ pharmacist æ›´æ–°å·²æ¥å—çš„é˜Ÿåˆ—

---

## ğŸ¯ å…³é”®æ”¹è¿›

1. **ä¸ä½¿ç”¨å‡½æ•°**ï¼šç›´æ¥ä½¿ç”¨ `EXISTS` æŸ¥è¯¢ï¼Œé¿å…å‡½æ•°åœ¨ RLS ä¸­çš„é—®é¢˜
2. **ç­–ç•¥æ¸…æ™°**ï¼šæ¯ä¸ªç­–ç•¥åªå¤„ç†ä¸€ç§æƒ…å†µ
3. **ç®€å•æŸ¥è¯¢**ï¼šå‰ç«¯åªåšç®€å•æŸ¥è¯¢ï¼Œè®© RLS å¤„ç†æƒé™
4. **è¯¦ç»†æ—¥å¿—**ï¼šæ·»åŠ è¶³å¤Ÿçš„è°ƒè¯•ä¿¡æ¯

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `database/rebuild_consultation_queue_rls.sql` - é‡å»º RLS ç­–ç•¥
- `database/verify_new_rls.sql` - éªŒè¯è„šæœ¬
- `src/components/PharmacistDashboard.jsx` - å‰ç«¯ä»£ç ï¼ˆå·²æ›´æ–°ï¼‰
- `REFACTOR_PLAN.md` - é‡æ„è®¡åˆ’

