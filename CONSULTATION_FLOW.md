# 实时咨询流程说明

## 📋 完整流程

### 用户端流程

1. **进入咨询**
   - 用户在欢迎页面点击 "💬 Start Realtime Consultation"
   - 进入等待队列页面 (`ConsultationWaiting`)

2. **等待匹配**
   - 系统自动匹配在线且不忙碌的药剂师
   - 显示等待位置和预计等待时间
   - 实时更新在线药剂师数量

3. **开始聊天**
   - 匹配成功后自动进入聊天界面 (`SimpleChat`)
   - 实时消息同步（支持轮询后备机制）
   - 药剂师可以推荐药物

4. **接受药物**
   - 药剂师推荐药物后，用户会看到药物推荐卡片
   - 用户可以点击 "Accept" 或 "Reject"
   - 接受的药物会保存到数据库

5. **完成咨询**
   - 用户点击 "✓ Complete Consultation & Review Medications" 按钮
   - 如果有接受的药物，自动跳转到药物确认页面
   - 如果没有接受的药物，显示确认对话框

6. **确认药物**
   - 在药物确认页面 (`ConsultationMedicationReview`) 查看所有接受的药物
   - 显示每个药物的详细信息（剂量、频率、用法等）
   - 显示总价和总数量
   - 点击 "Continue to Delivery & Payment" 继续

7. **配送信息**
   - 选择或输入配送地址
   - 输入电话号码
   - 继续到支付页面

8. **支付**
   - 选择支付方式
   - 完成订单
   - 显示成功页面

### 药剂师端流程

1. **上线**
   - 药剂师登录后进入管理面板
   - 在 "👨‍⚕️ Pharmacist" 标签中设置在线状态
   - 点击 "Go Online" 按钮

2. **接收咨询请求**
   - 系统自动匹配等待的用户
   - 在 "Waiting Queues" 中看到等待的用户
   - 点击 "Accept" 接受咨询

3. **进行咨询**
   - 进入聊天界面
   - 与用户实时聊天
   - 可以点击 "💊 Recommend Medication" 推荐药物

4. **推荐药物**
   - 搜索并选择药物
   - 填写用法用量、频率、时长等信息
   - 发送推荐
   - 用户会收到推荐卡片

5. **结束咨询**
   - 用户可以主动结束咨询
   - 药剂师也可以点击 "End Consultation" 结束

## 🔧 技术特性

### 实时功能
- **消息同步**：使用 Supabase Realtime + 轮询后备机制
- **药物推荐同步**：实时显示推荐和接受状态
- **队列更新**：实时显示等待位置和匹配状态

### 数据安全
- **RLS 策略**：确保用户只能查看自己的会话数据
- **权限控制**：药剂师只能管理自己的会话

### 用户体验
- **进度指示器**：显示当前步骤（Step 5-9）
- **统一样式**：咨询流程与正常流程样式一致
- **错误处理**：详细的错误提示和日志

## 📝 注意事项

1. **RLS 策略**：确保已运行所有必要的 SQL 脚本
2. **Realtime 启用**：确保已启用 Supabase Realtime
3. **测试**：所有功能已在测试模式下验证，现在已整合到正式版本

## 🚀 使用步骤

### 用户使用
1. 登录账户
2. 在欢迎页面点击 "💬 Start Realtime Consultation"
3. 等待匹配药剂师
4. 开始聊天并接受药物推荐
5. 完成咨询并确认药物
6. 填写配送信息并支付

### 药剂师使用
1. 登录管理员账户
2. 进入管理面板的 "👨‍⚕️ Pharmacist" 标签
3. 点击 "Go Online" 上线
4. 接受等待的咨询请求
5. 进行咨询并推荐药物
6. 结束咨询

