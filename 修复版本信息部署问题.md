# 修复版本信息部署问题

## 🔍 问题分析

版本信息在本地正常，但在 Vercel 部署后不显示，可能的原因：

1. **Vercel 构建时 Git 信息获取失败**
   - Vercel 构建环境可能没有完整的 Git 历史
   - `generate-version.js` 可能无法获取 Git 信息

2. **构建脚本执行顺序问题**
   - `version.json` 可能在构建时生成，但未被正确包含

3. **文件路径问题**
   - Vercel 构建环境的工作目录可能不同

## ✅ 解决方案

### 方案 1: 确保 Git 信息在构建时可用

Vercel 在构建时会浅克隆仓库，可能没有完整的 Git 历史。我们需要：

1. **在 Vercel 项目设置中启用完整 Git 历史**：
   - 进入 Vercel Dashboard → 项目设置 → General
   - 找到 "Git" 部分
   - 确保 "Shallow Clone" 未启用（或设置为 false）

2. **或者使用环境变量传递版本信息**：
   - 在 GitHub Actions 或本地构建时生成版本信息
   - 通过环境变量传递给 Vercel

### 方案 2: 修改构建脚本，使用环境变量

如果 Git 信息不可用，使用环境变量：

```javascript
// scripts/generate-version.js
const versionInfo = {
  commitHash: process.env.VERCEL_GIT_COMMIT_SHA?.substring(0, 7) || 'unknown',
  commitDate: process.env.VERCEL_GIT_COMMIT_MESSAGE || 'unknown',
  buildTime: new Date().toLocaleString('zh-CN', {...})
}
```

### 方案 3: 在构建前生成版本信息（推荐）

确保 `version.json` 在构建前已存在：

1. **提交 `version.json` 到 Git**（已做）
2. **在构建脚本中，如果 Git 命令失败，使用已存在的文件**

## 🔧 立即修复步骤

### 步骤 1: 更新 generate-version.js

修改脚本，使其在 Vercel 环境中也能工作：

```javascript
// 优先使用 Vercel 环境变量
const commitHash = process.env.VERCEL_GIT_COMMIT_SHA || 
                   execSync('git rev-parse HEAD', { encoding: 'utf-8' }).trim()
```

### 步骤 2: 检查 Vercel 构建日志

1. 进入 Vercel Dashboard
2. 查看最新部署的构建日志
3. 查找 `generate-version.js` 的输出
4. 确认是否有错误信息

### 步骤 3: 手动触发重新部署

1. 在 Vercel Dashboard → Deployments
2. 找到最新部署
3. 点击 "..." → "Redeploy"
4. **取消勾选** "Use existing Build Cache"
5. 点击 "Redeploy"

## 🧪 测试方法

### 本地测试构建

```bash
# 模拟 Vercel 构建环境
npm run build

# 检查生成的 version.json
cat src/version.json

# 预览构建结果
npm run preview
```

### 检查构建产物

构建完成后，检查 `dist` 目录：
- `dist/index.html` 应该存在
- `dist/assets/` 应该包含 JS 文件
- 检查 JS 文件中是否包含版本信息

## 📝 验证清单

- [ ] Vercel 构建日志显示 `✅ Version info generated`
- [ ] `version.json` 文件在构建产物中
- [ ] 浏览器控制台没有版本信息相关的错误
- [ ] 登录页面右下角显示版本信息
- [ ] 版本信息显示最新的日期和时间

## 🐛 如果仍然不显示

1. **检查浏览器控制台**：
   - 打开开发者工具（F12）
   - 查看 Console 标签
   - 查找是否有 `version.json` 加载错误

2. **检查网络请求**：
   - 打开 Network 标签
   - 刷新页面
   - 查找 `version.json` 的请求
   - 检查状态码和响应内容

3. **检查 Vercel 构建日志**：
   - 确认 `generate-version.js` 是否执行
   - 确认是否有错误信息
   - 确认 `version.json` 是否生成

