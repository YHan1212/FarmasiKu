# æ£€æŸ¥è‡ªåŠ¨åŒ¹é…è§¦å‘å™¨çš„é¢„æœŸè¾“å‡º

## è¿è¡Œ `check_auto_matching_triggers.sql` åçš„é¢„æœŸè¾“å‡º

### 1. æ£€æŸ¥è§¦å‘å™¨ï¼ˆç¬¬ä¸€éƒ¨åˆ†ï¼‰

**é¢„æœŸè¾“å‡º**ï¼šåº”è¯¥åªçœ‹åˆ°æ›´æ–°æ—¶é—´è§¦å‘å™¨ï¼Œä¸åº”è¯¥æœ‰è‡ªåŠ¨åŒ¹é…çš„è§¦å‘å™¨

```
trigger_name                          | event_manipulation | event_object_table    | action_statement
--------------------------------------|-------------------|----------------------|------------------
update_consultation_queue_updated_at  | UPDATE            | consultation_queue    | EXECUTE FUNCTION public.update_consultation_queue_updated_at()
```

**å¦‚æœçœ‹åˆ°å…¶ä»–è§¦å‘å™¨**ï¼ˆç‰¹åˆ«æ˜¯åŒ…å« `match` æˆ– `è‡ªåŠ¨åŒ¹é…` çš„ï¼‰ï¼Œè¯´æ˜æœ‰è‡ªåŠ¨åŒ¹é…é€»è¾‘ã€‚

---

### 2. æ£€æŸ¥å‡½æ•°ï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰

**é¢„æœŸè¾“å‡º**ï¼šåº”è¯¥ä¸ºç©ºæˆ–åªçœ‹åˆ°æ›´æ–°æ—¶é—´å‡½æ•°

```
routine_name | routine_type | routine_definition
-------------|--------------|-------------------
(ç©ºç»“æœ)
```

æˆ–è€…åªæœ‰ï¼š
```
routine_name                          | routine_type | routine_definition
--------------------------------------|--------------|------------------
update_consultation_queue_updated_at  | FUNCTION     | ...
update_consultation_medications_...   | FUNCTION     | ...
update_pharmacist_availability_...   | FUNCTION     | ...
```

**å¦‚æœçœ‹åˆ°åŒ…å« `matchPharmacist` æˆ– `è‡ªåŠ¨åŒ¹é…` çš„å‡½æ•°**ï¼Œè¯´æ˜æœ‰è‡ªåŠ¨åŒ¹é…é€»è¾‘ã€‚

---

### 3. æ£€æŸ¥å½“å‰ç”¨æˆ·çš„é˜Ÿåˆ—çŠ¶æ€ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰

**é¢„æœŸè¾“å‡ºç¤ºä¾‹**ï¼š
```
id                                   | patient_id                          | status    | matched_pharmacist_id | matched_at           | created_at
-------------------------------------|-------------------------------------|-----------|----------------------|---------------------|-------------------
abc123...                            | def456...                           | waiting   | NULL                  | NULL                | 2024-01-15 10:00:00
```

**å¦‚æœçœ‹åˆ° `status = 'matched'` æˆ– `'in_consultation'`**ï¼š
- è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç”¨æˆ·ç›´æ¥è¿›å…¥èŠå¤©äº†
- éœ€è¦æ¸…ç†è¿™äº›é˜Ÿåˆ—ï¼ˆè¿è¡Œ `cleanup_old_queues.sql`ï¼‰

---

### 4. æ£€æŸ¥å·²åŒ¹é…ä½†æœªå®Œæˆçš„é˜Ÿåˆ—ï¼ˆç¬¬å››éƒ¨åˆ†ï¼‰

**é¢„æœŸè¾“å‡º**ï¼šåº”è¯¥ä¸ºç©ºï¼ˆå¦‚æœæ²¡æœ‰æ—§çš„å·²åŒ¹é…é˜Ÿåˆ—ï¼‰

```
id | patient_id | status | matched_pharmacist_id | matched_at | created_at
---|------------|--------|----------------------|------------|------------
(ç©ºç»“æœ)
```

**å¦‚æœçœ‹åˆ°ç»“æœ**ï¼š
- è¯´æ˜æœ‰å·²åŒ¹é…çš„é˜Ÿåˆ—
- è¿™äº›é˜Ÿåˆ—ä¼šå¯¼è‡´ç”¨æˆ·ç›´æ¥è¿›å…¥èŠå¤©
- éœ€è¦æ¸…ç†ï¼ˆè¿è¡Œ `cleanup_old_queues.sql`ï¼‰

---

## âœ… æ­£å¸¸æƒ…å†µ

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š
1. âœ… åªæœ‰æ›´æ–°æ—¶é—´è§¦å‘å™¨ï¼ˆæ²¡æœ‰è‡ªåŠ¨åŒ¹é…è§¦å‘å™¨ï¼‰
2. âœ… åªæœ‰æ›´æ–°æ—¶é—´å‡½æ•°ï¼ˆæ²¡æœ‰è‡ªåŠ¨åŒ¹é…å‡½æ•°ï¼‰
3. âœ… å½“å‰ç”¨æˆ·çš„é˜Ÿåˆ—çŠ¶æ€æ˜¯ `'waiting'` æˆ–ä¸ºç©º
4. âœ… æ²¡æœ‰å·²åŒ¹é…ä½†æœªå®Œæˆçš„é˜Ÿåˆ—

---

## âš ï¸ å¦‚æœå‘ç°é—®é¢˜

### é—®é¢˜ 1: æœ‰è‡ªåŠ¨åŒ¹é…è§¦å‘å™¨
**è§£å†³**ï¼šåˆ é™¤è¯¥è§¦å‘å™¨
```sql
DROP TRIGGER IF EXISTS trigger_name ON public.consultation_queue;
```

### é—®é¢˜ 2: æœ‰è‡ªåŠ¨åŒ¹é…å‡½æ•°
**è§£å†³**ï¼šåˆ é™¤è¯¥å‡½æ•°
```sql
DROP FUNCTION IF EXISTS function_name;
```

### é—®é¢˜ 3: æœ‰å·²åŒ¹é…çš„é˜Ÿåˆ—
**è§£å†³**ï¼šè¿è¡Œæ¸…ç†è„šæœ¬
```sql
-- åœ¨ cleanup_old_queues.sql ä¸­å–æ¶ˆæ³¨é‡Šåˆ é™¤è¯­å¥
```

---

## ğŸ“ å¦‚ä½•æŸ¥çœ‹è¾“å‡º

1. åœ¨ Supabase SQL Editor ä¸­è¿è¡Œè„šæœ¬
2. æŸ¥çœ‹æ¯ä¸ªæŸ¥è¯¢çš„ç»“æœ
3. å¯¹æ¯”ä¸Šé¢çš„é¢„æœŸè¾“å‡º
4. å¦‚æœå‘ç°å¼‚å¸¸ï¼Œå‘Šè¯‰æˆ‘å…·ä½“çœ‹åˆ°äº†ä»€ä¹ˆ

