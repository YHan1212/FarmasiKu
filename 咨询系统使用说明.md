# å’¨è¯¢ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

1. **role=user åˆ›å»ºé˜Ÿåˆ—**ï¼šç”¨æˆ·å¯ä»¥é€‰æ‹©ç—‡çŠ¶å¹¶åŠ å…¥å’¨è¯¢é˜Ÿåˆ—
2. **role=doctor æŸ¥çœ‹é˜Ÿåˆ—**ï¼šåŒ»ç”Ÿå¯ä»¥çœ‹åˆ°æ‰€æœ‰ç­‰å¾…ä¸­çš„é˜Ÿåˆ—
3. **role=doctor æ¥å—é˜Ÿåˆ—**ï¼šåŒ»ç”Ÿå¯ä»¥æ¥å—é˜Ÿåˆ—å¹¶è¿›å…¥èŠå¤©å®¤

## ğŸ“‹ è®¾ç½®æ­¥éª¤

### æ­¥éª¤ 1: è¿è¡Œæ•°æ®åº“ RLS ç­–ç•¥è„šæœ¬

åœ¨ Supabase SQL Editor ä¸­è¿è¡Œï¼š

```sql
-- è¿è¡Œ database/fix_consultation_complete.sql
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- åˆ é™¤æ‰€æœ‰æ—§çš„ RLS ç­–ç•¥
- åˆ›å»ºæ–°çš„ç­–ç•¥ï¼Œæ”¯æŒï¼š
  - `role=user` å¯ä»¥åˆ›å»ºé˜Ÿåˆ—ï¼ˆINSERTï¼‰
  - `role=doctor` å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ waiting é˜Ÿåˆ—ï¼ˆSELECTï¼‰
  - `role=doctor` å¯ä»¥æ¥å—é˜Ÿåˆ—å¹¶è¿›å…¥èŠå¤©å®¤ï¼ˆUPDATEï¼‰

### æ­¥éª¤ 2: è®¾ç½®ç”¨æˆ·è§’è‰²

ç¡®ä¿ä½ çš„ç”¨æˆ·æœ‰æ­£ç¡®çš„è§’è‰²ï¼š

```sql
-- è®¾ç½®ç”¨æˆ·ä¸º user è§’è‰²
UPDATE public.user_profiles 
SET role = 'user' 
WHERE id = 'ç”¨æˆ·ID';

-- è®¾ç½®ç”¨æˆ·ä¸º doctor è§’è‰²
UPDATE public.user_profiles 
SET role = 'doctor' 
WHERE id = 'åŒ»ç”ŸID';
```

### æ­¥éª¤ 3: æµ‹è¯•æµç¨‹

1. **ç”¨æˆ·ç«¯ï¼ˆrole=userï¼‰**ï¼š
   - ç™»å½•åº”ç”¨
   - é€‰æ‹©ç—‡çŠ¶
   - ç‚¹å‡»"å’¨è¯¢è¯å‰‚å¸ˆ"
   - ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—ï¼ˆstatus: 'waiting'ï¼‰
   - æ˜¾ç¤ºç­‰å¾…ç•Œé¢

2. **åŒ»ç”Ÿç«¯ï¼ˆrole=doctorï¼‰**ï¼š
   - ç™»å½•åº”ç”¨
   - è¿›å…¥ Admin Dashboard â†’ Pharmacist Dashboard
   - åœ¨ "Waiting Consultations" éƒ¨åˆ†çœ‹åˆ°ç­‰å¾…çš„é˜Ÿåˆ—
   - ç‚¹å‡» "Accept & Start Chat" æŒ‰é’®
   - ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
     - æ›´æ–°é˜Ÿåˆ—çŠ¶æ€ä¸º 'accepted'ï¼Œç„¶å 'in_chat'
     - åˆ›å»º `consultation_sessions` è®°å½•
     - å¦‚æœåŒ»ç”Ÿæ²¡æœ‰é“¾æ¥ `doctors` è¡¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª
     - è¿›å…¥èŠå¤©å®¤

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### RLS ç­–ç•¥è¯´æ˜

#### SELECT ç­–ç•¥ï¼ˆæŸ¥çœ‹é˜Ÿåˆ—ï¼‰
- **Users can view own queue**ï¼šç”¨æˆ·å¯ä»¥çœ‹åˆ°è‡ªå·±çš„é˜Ÿåˆ—
- **Admins can view all waiting queues**ï¼šAdmin å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ waiting é˜Ÿåˆ—
- **Doctors can view waiting queues**ï¼š`role=doctor` å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ waiting é˜Ÿåˆ—
- **Linked pharmacists can view waiting queues**ï¼šé“¾æ¥äº† pharmacist account çš„ç”¨æˆ·å¯ä»¥æŸ¥çœ‹ waiting é˜Ÿåˆ—

#### INSERT ç­–ç•¥ï¼ˆåˆ›å»ºé˜Ÿåˆ—ï¼‰
- **Users can create queue**ï¼š`role=user` å¯ä»¥åˆ›å»ºé˜Ÿåˆ—
- **Authenticated users can create own queue**ï¼šå·²è®¤è¯ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„é˜Ÿåˆ—ï¼ˆå‘åå…¼å®¹ï¼‰

#### UPDATE ç­–ç•¥ï¼ˆæ›´æ–°é˜Ÿåˆ—ï¼‰
- **Users can update own queue**ï¼šç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„é˜Ÿåˆ—ï¼ˆå–æ¶ˆç­‰ï¼‰
- **Doctors can accept queues**ï¼š`role=doctor` å¯ä»¥æ¥å— waiting é˜Ÿåˆ—
- **Doctors can update accepted queues**ï¼š`role=doctor` å¯ä»¥æ›´æ–°å·²æ¥å—çš„é˜Ÿåˆ—
- **Linked pharmacists can accept queues**ï¼šé“¾æ¥äº† pharmacist account çš„ç”¨æˆ·å¯ä»¥æ¥å—é˜Ÿåˆ—

### è‡ªåŠ¨åˆ›å»º doctors è®°å½•

å¦‚æœ `role=doctor` çš„ç”¨æˆ·æ²¡æœ‰é“¾æ¥ `doctors` è¡¨ï¼Œç³»ç»Ÿä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨åˆ›å»ºï¼š
1. åŠ è½½ Pharmacist Dashboard æ—¶
2. æ¥å—é˜Ÿåˆ—æ—¶ï¼ˆå¦‚æœä¹‹å‰æ²¡æœ‰åˆ›å»ºï¼‰

åˆ›å»ºçš„ `doctors` è®°å½•ï¼š
- `user_id`: å½“å‰ç”¨æˆ·çš„ ID
- `name`: 'Doctor'ï¼ˆé»˜è®¤å€¼ï¼‰

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1: ç”¨æˆ·æ— æ³•åˆ›å»ºé˜Ÿåˆ—

**é”™è¯¯ä¿¡æ¯**ï¼š`new row violates row-level security policy`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦ä¸º `user`ï¼š
   ```sql
   SELECT role FROM public.user_profiles WHERE id = 'ç”¨æˆ·ID';
   ```
2. å¦‚æœè§’è‰²ä¸æ˜¯ `user`ï¼Œæ›´æ–°ï¼š
   ```sql
   UPDATE public.user_profiles SET role = 'user' WHERE id = 'ç”¨æˆ·ID';
   ```
3. é‡æ–°è¿è¡Œ `database/fix_consultation_complete.sql`

### é—®é¢˜ 2: åŒ»ç”Ÿçœ‹ä¸åˆ°ç­‰å¾…é˜Ÿåˆ—

**é”™è¯¯ä¿¡æ¯**ï¼šé˜Ÿåˆ—åˆ—è¡¨ä¸ºç©º

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥åŒ»ç”Ÿè§’è‰²æ˜¯å¦ä¸º `doctor`ï¼š
   ```sql
   SELECT role FROM public.user_profiles WHERE id = 'åŒ»ç”ŸID';
   ```
2. å¦‚æœè§’è‰²ä¸æ˜¯ `doctor`ï¼Œæ›´æ–°ï¼š
   ```sql
   UPDATE public.user_profiles SET role = 'doctor' WHERE id = 'åŒ»ç”ŸID';
   ```
3. æ£€æŸ¥æ˜¯å¦æœ‰ waiting é˜Ÿåˆ—ï¼š
   ```sql
   SELECT * FROM public.consultation_queue WHERE status = 'waiting';
   ```
4. é‡æ–°è¿è¡Œ `database/fix_consultation_complete.sql`

### é—®é¢˜ 3: åŒ»ç”Ÿæ— æ³•æ¥å—é˜Ÿåˆ—

**é”™è¯¯ä¿¡æ¯**ï¼š`Please link a pharmacist account in the Admin panel first`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸º `role=doctor` çš„ç”¨æˆ·åˆ›å»º `doctors` è®°å½•
- å¦‚æœä»ç„¶å¤±è´¥ï¼Œæ£€æŸ¥ï¼š
  1. ç”¨æˆ·è§’è‰²æ˜¯å¦ä¸º `doctor`
  2. æ˜¯å¦æœ‰æƒé™åˆ›å»º `doctors` è®°å½•ï¼ˆæ£€æŸ¥ `doctors` è¡¨çš„ RLS ç­–ç•¥ï¼‰

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è§’è‰²è®¾ç½®**ï¼šç¡®ä¿ç”¨æˆ·è§’è‰²æ­£ç¡®è®¾ç½®ï¼ˆ`user` æˆ– `doctor`ï¼‰
2. **RLS ç­–ç•¥**ï¼šæ¯æ¬¡ä¿®æ”¹ RLS ç­–ç•¥åï¼Œéœ€è¦é‡æ–°è¿è¡Œå®Œæ•´çš„ç­–ç•¥è„šæœ¬
3. **è‡ªåŠ¨åˆ›å»º doctors**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨ä¸º `role=doctor` çš„ç”¨æˆ·åˆ›å»º `doctors` è®°å½•ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
4. **é˜Ÿåˆ—çŠ¶æ€**ï¼šé˜Ÿåˆ—çŠ¶æ€æµè½¬ï¼š`waiting` â†’ `accepted` â†’ `in_chat` â†’ `completed`

## âœ… éªŒè¯æ¸…å•

- [ ] è¿è¡Œäº† `database/fix_consultation_complete.sql`
- [ ] ç”¨æˆ·è§’è‰²è®¾ç½®ä¸º `user`
- [ ] åŒ»ç”Ÿè§’è‰²è®¾ç½®ä¸º `doctor`
- [ ] ç”¨æˆ·å¯ä»¥åˆ›å»ºé˜Ÿåˆ—
- [ ] åŒ»ç”Ÿå¯ä»¥çœ‹åˆ°ç­‰å¾…é˜Ÿåˆ—
- [ ] åŒ»ç”Ÿå¯ä»¥æ¥å—é˜Ÿåˆ—
- [ ] åŒ»ç”Ÿå¯ä»¥è¿›å…¥èŠå¤©å®¤

