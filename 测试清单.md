# 测试清单

## ✅ 需要测试的功能

### 1. 用户端（role=user）测试

#### 测试 1: 创建咨询队列
- [ ] 登录用户账号（role=user）
- [ ] 选择症状
- [ ] 点击"咨询药剂师"
- [ ] **预期结果**：成功创建队列，显示等待界面
- [ ] **检查**：浏览器控制台是否有错误

#### 测试 2: 查看等待状态
- [ ] 确认显示等待界面
- [ ] 显示队列位置、预计等待时间、在线药剂师数量
- [ ] **预期结果**：信息正确显示

### 2. 医生端（role=doctor）测试

#### 测试 3: 查看等待队列
- [ ] 登录医生账号（role=doctor）
- [ ] 进入 Admin Dashboard → Pharmacist Dashboard
- [ ] **预期结果**：在 "Waiting Consultations" 部分看到等待的队列
- [ ] **检查**：队列信息是否正确显示（患者、症状、时间等）

#### 测试 4: 接受队列并进入聊天
- [ ] 点击队列的 "Accept & Start Chat" 按钮
- [ ] **预期结果**：
  - 队列状态更新为 'accepted'，然后 'in_chat'
  - 自动创建 `consultation_sessions` 记录
  - 进入聊天界面
- [ ] **检查**：浏览器控制台是否有错误

#### 测试 5: 聊天功能
- [ ] 医生可以发送消息
- [ ] 用户可以看到消息
- [ ] 用户可以回复消息
- [ ] **预期结果**：消息实时同步

#### 测试 6: 推荐药物
- [ ] 医生推荐药物
- [ ] **预期结果**：用户收到药物推荐通知

### 3. 数据库测试

#### 测试 7: 检查数据库记录
在 Supabase Dashboard 中检查：
- [ ] `consultation_queue` 表中有新记录（status='waiting'）
- [ ] 医生接受后，队列状态更新为 'in_chat'
- [ ] `consultation_sessions` 表中有新记录（status='active'）

### 4. RLS 策略测试

#### 测试 8: 权限检查
- [ ] role=user 只能看到自己的队列
- [ ] role=doctor 可以看到所有 waiting 队列
- [ ] role=doctor 可以接受队列
- [ ] **预期结果**：权限正确，没有 RLS 错误

## 🐛 如果遇到问题

### 问题 1: 用户无法创建队列
**错误信息**：`new row violates row-level security policy`

**解决方案**：
1. 检查用户角色是否为 `user`
2. 运行 `database/fix_consultation_complete.sql`

### 问题 2: 医生看不到等待队列
**错误信息**：队列列表为空

**解决方案**：
1. 检查医生角色是否为 `doctor`
2. 运行 `database/fix_consultation_complete.sql`
3. 检查浏览器控制台的错误信息

### 问题 3: 医生无法接受队列
**错误信息**：`Please link a pharmacist account`

**解决方案**：
- 系统会自动为 role=doctor 的用户创建 `doctors` 记录
- 如果仍然失败，检查浏览器控制台的错误信息

## 📝 测试步骤

### 完整流程测试

1. **准备两个账号**：
   - 用户账号（role=user）
   - 医生账号（role=doctor）

2. **用户端操作**：
   - 登录用户账号
   - 选择症状并创建咨询队列
   - 等待医生接受

3. **医生端操作**：
   - 登录医生账号
   - 进入 Pharmacist Dashboard
   - 查看等待队列
   - 接受队列
   - 进入聊天

4. **验证**：
   - 检查数据库记录
   - 检查浏览器控制台
   - 确认功能正常

## ✅ 测试完成标准

- [ ] 用户可以成功创建队列
- [ ] 医生可以看到等待队列
- [ ] 医生可以接受队列
- [ ] 聊天功能正常
- [ ] 没有 RLS 错误
- [ ] 数据库记录正确

